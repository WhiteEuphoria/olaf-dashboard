# Admin Dashboard Editing Enhancements

## Что сделано
- **Фикс Blade-шаблона.** Очистил `resources/views/admin/dashboard.blade.php` от артефактов скомпилированного PHP, вернул чистый Blade-код для попапов и списков вложений, заменил однострочные `@php(...)` на блочные инструкции и убрал причину 500-х при переключении клиентов.
- **Унификация транзакций и выводов.** Админские блоки «Последние транзакции» и «Заявки на вывод средств» перешли на тот же формат, что и `User info`/`Bank accounts`: каждая запись выводится через `admin-panel__field` с подписями и бордерами, статус и дата находятся в шапке карточки, а реквизиты выводов отображаются отдельными полями.
- **Инлайн-редактирование транзакций и выводов.** Из карточки можно включить режим редактирования, править значения прямо в тех же инпутах и сохранить/отменить изменения (используются существующие маршруты обновлений). Списки выбора транзакции/заявки вынесены наверх блока.
- **Обновлённые стили.** В `resources/personal-acc/css/style.css` добавлены классы `admin-panel__entry*`, `admin-panel__field--wide`, `admin-panel__field--full` и обновлённая сетка `admin-panel__grid--entry`, чтобы длинные реквизиты (IBAN и т.п.) помещались без обрезания.
- **Клиентская вкладка Withdrawals.** В пользовательском дашборде добавлены переключатели между транзакциями и заявками на вывод: карточки и таблица переключаются синхронно, а кнопка `Report a violation` вернула красный стиль (`client/dashboard/partials/overview.blade.php`, `resources/personal-acc/js/app.js`, `resources/personal-acc/css/style.css`).
- **Табы Transactions/Withdrawals.** Заголовок блока транзакций превращён в две кликабельные вкладки; при переключении показываются соответствующие списки без лишнего дубляжа текста, сохранён фирменный стиль и иконки (`client/dashboard/partials/overview.blade.php`, `resources/personal-acc/js/app.js`, `resources/personal-acc/css/style.css`).
- **Инлайн-редактирование пользователя.** Поля блока `User info` теперь можно редактировать прямо на странице: кнопка «Редактировать» переводит форму в активный режим, появляются кнопки «Сохранить» и «Отмена». Значения валидации и формат валют повторяют логику Filament.
- **Редактирование даты создания.** `Created at` переводится в формат `datetime-local`, изменения пробрасываются в контроллер и сохраняются.
- **Инлайн-редактирование счёта.** Для выбранного счёта из блока `Bank accounts` открывается форма редактирования с теми же полями, что и в Filament (тип, статус, баланс, валюта, инициалы и т.д.). Переключение между счетами сохраняет предыдущий режим. Значение валюты синхронизируется с блоком `User info`, но при ручном выборе фиксируется за счёт флага `currencyTouched`.
- **Создание/выбор счёта.** После создания новый счёт автоматически выбирается в дропдауне (`redirect` возвращает `account` id), а установка флага «Основной» сбрасывает остальные счета этого пользователя.
- **Актуализация валют и состояния.** Значения валют для балансов синхронизируются с выбранной валютой пользователя или счёта. При отмене редактирования данные откатываются к исходным.
- **Формат выпадающих списков.** Селекты полностью нативные (без кастомного JS Filament), имеют arrow-иконку, расширенные отступы и активируются вместе с формой.
- **Починка режимов редактирования.** Скрипт переводит селекты/checkbox’ы в активное состояние без optional chaining, что обеспечивает совместимость и возвращает работу кнопок «Редактировать».
- **Новые маршруты и действия.** Добавлены PUT-эндпоинты `admin.dashboard.*.update` для обновления пользователя, счетов, транзакций, выводов, документов и жалоб.
- **Создание транзакций.** POST-форма под блоком «Последние транзакции» (кнопка перенесена под таблицу) создаёт записи с валидацией принадлежности счёта выбранному пользователю — ошибки возвращаются в модалку без 404.
- **Превью документов.** В разделе «Документы» миниатюры стали крупнее, изображения открываются в модальном окне, а сами файлы отдаются через защищённый `preview`-endpoint (даже без публичного `storage` symlink). Для не-графических форматов показывается бейдж расширения, при отсутствии файла — заглушка.
- **Отдельная лента транзакций.** Кнопка «View all transactions» трансформирована в красную «Report a violation», а полный список операций вынесен на страницу `/user/transactions` (без Filament). Она повторяет пользовательский стиль, использует тот же модал для вывода средств и доступна только подтверждённым клиентам.
- **Сообщения о нарушениях.** Пользователь теперь может отправлять жалобы сколько угодно раз: формы в дашборде, модалке и на странице `/user/violation` отправляют данные в `FraudClaim`, ошибки показываются рядом с полем, успешная отправка подтверждается сообщением.
- **Админская заявка на вывод.** В разделе «Заявки на вывод средств» отображается полный набор реквизитов (карта, IBAN/BIC, криптоадрес и любые дополнительные поля), а модалка редактирования позволяет менять метод, счёт списания, сумму, статус и каждое поле реквизитов с сохранением в JSON.
- **Расширенные тесты.** Фича-тесты прикрывают обновление и создание сущностей: пользователя, счёта, транзакции (включая новую форму), вывода, документа и жалобы. Проверяется редирект и сохранённые значения.
- **Фильтр ожидающих клиентов.** В блоке `User selection` добавлена отдельная селекция «Pending user»: как только статус меняется на Approved, клиент исчезает из списка и появляется в основном выпадающем меню.
- **Клиентский вход и регистрация.** `/user/login` использует новую форму с «запомнить» и прямой ссылкой на регистрацию, а `/user/register` создаёт клиента, сразу собирая документы на верификацию через стилизованную кнопку загрузки и автоматом переносит на страницу ожидания.
- **Заявки на вывод для клиента.** Страница `/user/withdraw` и модалка на дашборде подключены к бэкенду: заявки по картам, IBAN и крипте уходят в таблицу `withdrawals`, ошибки выводятся под полями, стоит запоминание последней вкладки и статус успешной отправки.
- **Вложения к нарушениям.** Формы «Report a violation» на стороне пользователя и админа поддерживают загрузку до пяти файлов (скриншоты, документы); администратор видит миниатюры изображений, открывает их в модалке и может скачать любые вложения. Файлы хранятся в новой таблице, доступны только в админке и управляются прямо из модального окна редактирования.
- **Синхронизация баланса.** При изменении `main_balance` или `currency` в админке обновляется баланс и валюта основного счёта клиента, что видно в кабинете пользователя.
- **Страница ожидания верификации.** После отправки файлов (или логина неподтверждённого клиента) пользователю показывается заглушка `verify` в фирменном стиле; доступ к кабинету `/user` автоматически блокируется до статуса `approved/active`.
- **Маршруты и выход.** Роуты клиентского раздела сгруппированы под `/user`, добавлен `POST /user/logout`, а старые `/login`, `/register`, `/verify` перенаправляют на новые адреса.
- **Тесты авторизации.** Новый набор `UserAuthFlowTest` проверяет регистрацию с документами, редирект незавершённых пользователей на заглушку и поведение логина.
- **Единая типографика.** Заголовки, подписи, инпуты и селекты получили согласованные размеры и цвета: лейблы в админке читаемее, выпадающие списки увеличены, кнопки прикрепления файлов и списки превью унифицированы с пользовательскими формами.

## Ключевые файлы
- `resources/views/admin/dashboard.blade.php` — основной шаблон: инлайн-формы, кнопки режима редактирования, скрипт для переключения состояний и синхронизации валют.
- `app/Http/Controllers/Admin/AdminDashboardController.php` — методы `updateUser`, `updateAccount`, `updateTransaction`, `updateWithdrawal`, `updateDocument`, `updateFraudClaim` с валидацией по образцу Filament.
- `routes/web.php` — регистрация новых PUT-маршрутов.
- `database/migrations/2025_09_25_053508_create_fraud_claim_attachments_table.php` — таблица с файлами жалоб.
- `app/Models/FraudClaim.php`, `app/Models/FraudClaimAttachment.php` — связи и методы для управления вложениями сообщений о нарушении.
- `app/Http/Controllers/Client/ViolationController.php`, `app/Http/Controllers/Admin/AdminDashboardController.php` — приём и отображение файлов жалоб, скачивание и предпросмотр изображений.
- `resources/personal-acc/css/style.css`, `resources/personal-acc/js/app.js` — обновлённые размеры шрифтов, стили селектов и логика предпросмотра выбранных файлов.
- `resources/views/user/withdraw.blade.php`, `resources/views/user/partials/withdraw-modal.blade.php` — форма клиента с поддержкой множественной загрузки и отображением выбранных файлов.
- `app/Http/Controllers/Auth/ClientRegisterController.php`, `app/Http/Controllers/Auth/ClientLoginController.php` — клиентский вход и регистрация с проверкой статусов.
- `resources/views/user/auth/*.blade.php` — шаблоны логина, регистрации и ожидания верификации.
- `tests/Feature/AdminDashboardTest.php`, `tests/Feature/UserAuthFlowTest.php` — фича-тесты для админки и нового клиентского флоу, включая сценарии с вложениями.

## Проверка
- Все автоматические тесты: `php artisan test`
